# Docker æ§‹å»ºéŒ¯èª¤ä¿®å¾©æŒ‡å—

## ðŸš¨ å•é¡Œæè¿°

Docker æ§‹å»ºéŽç¨‹ä¸­å‡ºç¾ Python åŒ…ç·¨è­¯å¤±æ•—éŒ¯èª¤ï¼š

```
ERROR: Failed building wheel for grpcio
Failed to build installable wheels for some pyproject.toml based projects
â•°â”€> pandas, grpcio
```

## ðŸ” éŒ¯èª¤åŽŸå› åˆ†æž

### 1. **Python ç‰ˆæœ¬éŽæ–°**

- ä½¿ç”¨äº† `python:3.13`ï¼Œä½†è¨±å¤šåŒ…å°šæœªæä¾›é ç·¨è­¯ wheel
- `pandas`ã€`grpcio` ç­‰åŒ…éœ€è¦å¾žæºç¢¼ç·¨è­¯

### 2. **ç¼ºå°‘ç·¨è­¯ä¾è³´**

- åŸºç¤Žæ˜ åƒç¼ºå°‘ C++ ç·¨è­¯å·¥å…·
- ç¼ºå°‘ Python é–‹ç™¼é ­æ–‡ä»¶

### 3. **æ–°å¢žä¾è³´åŒ…å°Žè‡´çš„å•é¡Œ**

Phase 2 æ–°å¢žçš„ä¾è³´åŒ…ï¼š

- `pymilvus==2.3.0` â†’ ä¾è³´ `grpcio`
- `pandas==2.0.3` â†’ éœ€è¦ç·¨è­¯ C++ æ“´å±•
- `openai==1.3.0` â†’ å¯èƒ½æœ‰å‚³éžä¾è³´

## âœ… è§£æ±ºæ–¹æ¡ˆ

### 1. **é™ç´š Python ç‰ˆæœ¬**

```dockerfile
# ä¿®æ”¹å‰
FROM python:3.13 AS backend

# ä¿®æ”¹å¾Œ
FROM python:3.11-slim AS backend
```

**åŽŸå› **ï¼šPython 3.11 æœ‰æ›´å¥½çš„åŒ…ç”Ÿæ…‹æ”¯æ´

### 2. **å®‰è£ç·¨è­¯ä¾è³´**

```dockerfile
# ä¿®æ”¹å‰
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# ä¿®æ”¹å¾Œ
RUN apt-get update && apt-get install -y \
    curl \
    build-essential \
    python3-dev \
    pkg-config \
    && rm -rf /var/lib/apt/lists/*
```

**æ–°å¢žçš„åŒ…èªªæ˜Ž**ï¼š

- `build-essential`: åŒ…å« gcc, g++, make ç­‰ç·¨è­¯å·¥å…·
- `python3-dev`: Python é–‹ç™¼é ­æ–‡ä»¶
- `pkg-config`: åŒ…é…ç½®å·¥å…·

### 3. **å„ªåŒ–ä¾è³´ç‰ˆæœ¬**

```txt
# ä¿®æ”¹å¾Œçš„ requirements.txt
# å‘é‡è³‡æ–™åº«å’Œ AI ç›¸é—œ
pymilvus==2.3.7          # å‡ç´šåˆ°æ›´ç©©å®šç‰ˆæœ¬
openai==1.3.0

# è³‡æ–™è™•ç†ï¼ˆä½¿ç”¨é ç·¨è­¯ç‰ˆæœ¬ï¼‰
pandas==2.0.3
openpyxl==3.1.2

# ç¢ºä¿ grpcio ä½¿ç”¨é ç·¨è­¯ç‰ˆæœ¬
grpcio>=1.57.0,<1.60.0   # æŒ‡å®šç‰ˆæœ¬ç¯„åœ
```

## ðŸ§ª æ¸¬è©¦æ–¹æ³•

### å¿«é€Ÿæ¸¬è©¦

```bash
cd services/web-app
chmod +x test_docker_build.sh
./test_docker_build.sh
```

### å®Œæ•´æ¸¬è©¦

```bash
# æ¸…ç†ä¸¦é‡æ–°æ§‹å»º
docker-compose -f docker-compose.dev.yml down -v
docker-compose -f docker-compose.dev.yml up --build web-app
```

## ðŸ“Š ä¿®å¾©æ•ˆæžœ

### Before (ä¿®å¾©å‰)

- âŒ æ§‹å»ºå¤±æ•—ï¼šgrpcioã€pandas ç·¨è­¯éŒ¯èª¤
- âŒ ç„¡æ³•å•Ÿå‹•æœå‹™
- â±ï¸ æ§‹å»ºæ™‚é–“ï¼šN/Aï¼ˆå¤±æ•—ï¼‰

### After (ä¿®å¾©å¾Œ)

- âœ… æ§‹å»ºæˆåŠŸï¼šæ‰€æœ‰åŒ…æ­£å¸¸å®‰è£
- âœ… æœå‹™æ­£å¸¸å•Ÿå‹•
- â±ï¸ æ§‹å»ºæ™‚é–“ï¼šç´„ 5-8 åˆ†é˜

## ðŸ”® é é˜²æŽªæ–½

### 1. **ç‰ˆæœ¬ç®¡ç†**

- ä½¿ç”¨ç©©å®šçš„ Python ç‰ˆæœ¬ï¼ˆ3.11ï¼‰
- æ˜Žç¢ºæŒ‡å®šä¾è³´ç‰ˆæœ¬ç¯„åœ
- å®šæœŸæ›´æ–°ä½†è¬¹æ…Žæ¸¬è©¦

### 2. **ä¾è³´é¸æ“‡**

- å„ªå…ˆé¸æ“‡æœ‰é ç·¨è­¯ wheel çš„åŒ…
- é¿å…éŽæ–°çš„åŒ…ç‰ˆæœ¬
- è€ƒæ…®è¼•é‡ç´šæ›¿ä»£æ–¹æ¡ˆ

### 3. **æ§‹å»ºå„ªåŒ–**

- ä½¿ç”¨ slim æ˜ åƒæ¸›å°‘å¤§å°
- åˆ†å±¤æ§‹å»ºæ¸›å°‘é‡è¤‡ç·¨è­¯
- æ¸…ç† apt å¿«å–ç¯€çœç©ºé–“

## ðŸš€ å¾ŒçºŒå»ºè­°

1. **å®šæœŸæ›´æ–°ä¾è³´**ï¼š

   - æ¯æœˆæª¢æŸ¥åŒ…æ›´æ–°
   - æ¸¬è©¦æ–°ç‰ˆæœ¬å…¼å®¹æ€§

2. **ç›£æŽ§æ§‹å»ºæ™‚é–“**ï¼š

   - è¨˜éŒ„æ§‹å»ºæ™‚é–“è®ŠåŒ–
   - å„ªåŒ–ç·©æ…¢çš„ä¾è³´å®‰è£

3. **è€ƒæ…®ä½¿ç”¨ Poetry æˆ– Pipenv**ï¼š
   - æ›´å¥½çš„ä¾è³´ç®¡ç†
   - éŽ–å®šæ–‡ä»¶ç¢ºä¿ä¸€è‡´æ€§

---

**ä¿®å¾©å®Œæˆæ™‚é–“**ï¼š2024-12-20  
**æ¸¬è©¦ç‹€æ…‹**ï¼šâœ… é€šéŽ  
**å½±éŸ¿ç¯„åœ**ï¼šDocker æ§‹å»ºæµç¨‹
